properties([
    buildDiscarder(logRotator(artifactDaysToKeepStr: '30', artifactNumToKeepStr: '', daysToKeepStr: '30')),
    disableConcurrentBuilds(),
    disableResume(),
])

node() {
    checkout scm
    buildlib = load("pipeline-scripts/buildlib.groovy")
    commonlib = buildlib.commonlib

    stage('sync bucket local') {
        withCredentials([file(credentialsId: 'rhacs-sync-gs-account', variable: 'FILE')]) {
            sh '''
            export PATH=$PATH:/mnt/nfs/home/jenkins/google-cloud-sdk/bin
            rm -rf .config
            mkdir .config
            export CLOUDSDK_CONFIG=$PWD/.config
            gcloud auth activate-service-account --key-file=$FILE
            DEST=/mnt/workspace/buckets/rhacs-openshift-mirror-src
            mkdir -p $DEST
            gsutil rsync -r gs://rhacs-openshift-mirror-src $DEST
            '''
        }
    }

    stage('sync support packages') {
        s3_target_dir = "/pub/openshift-v4/x86_64/clients/${kind}/${dest_version}/"
        commonlib.shell([
            "set -euxo pipefail",
            "tree ${source_dir}",
            "cat ${source_dir}/sha256sum.txt"
        ].join('\n'))
        println("params.DRY_RUN: ${params.DRY_RUN}")
        if (params.DRY_RUN) {
            println("Would have s3 sync'ed ${source_dir} to ${s3_target_dir}")
        } else {
            commonlib.syncDirToS3Mirror(source_dir, s3_target_dir)
        }
    }

    stage('push to mirror') {
        LOCAL_SYNC_DIR="/mnt/workspace/buckets/rhacs-openshift-mirror-src"

        withCredentials([aws(credentialsId: 's3-art-srv-enterprise', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
            commonlib.shell(
                script: """
                    set -e
                    aws s3 sync --no-progress --exact-timestamps --delete ${LOCAL_SYNC_DIR}/assets/ s3://art-srv-enterprise/pub/rhacs/assets/
                    aws s3 sync --no-progress --exact-timestamps --delete ${LOCAL_SYNC_DIR}/charts/ s3://art-srv-enterprise/pub/rhacs/charts/
                    aws s3 sync --no-progress --exact-timestamps --delete ${LOCAL_SYNC_DIR}/support-packages/ s3://art-srv-enterprise/pub/rhacs/support-packages/
                """
            )
        }

    }
}
